# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1pGJvidgmFMvbR-nEnOuhLFMezDUEkfFC
"""

import zipfile
import os

# Path to the zip file
zip_file_path = '/content/drive/MyDrive/agri22.zip'

# Specify the folder where you want to extract the files
output_folder = '/content/drive/MyDrive/extracted_folder/'

# Make sure the output folder exists
os.makedirs(output_folder, exist_ok=True)

# Open and extract the zip file
with zipfile.ZipFile(zip_file_path, 'r') as zip_ref:
    zip_ref.extractall(output_folder)

print(f'Files extracted to {output_folder}')



import torch
import torch.nn as nn
import torch.optim as optim
from torch.utils.data import DataLoader
from torchvision import datasets, transforms, models
from sklearn.metrics import f1_score
from tqdm import tqdm
import matplotlib.pyplot as plt
from collections import Counter
import numpy as np


# Spatial Attention Module
class SpatialAttention(nn.Module):
    def _init_(self, in_channels):
        super(SpatialAttention, self)._init_()
        self.conv1 = nn.Conv2d(in_channels, 1, kernel_size=7, padding=3)
        self.sigmoid = nn.Sigmoid()

    def forward(self, x):
        attn_map = self.sigmoid(self.conv1(x))
        return x * attn_map  # Element-wise multiplication

    def visualize_attention(self, x, attn_map):
        plt.figure(figsize=(10, 5))
        plt.subplot(1, 2, 1)
        plt.imshow(x.cpu().squeeze(0).permute(1, 2, 0))
        plt.title("Input Image")
        plt.subplot(1, 2, 2)
        plt.imshow(attn_map.cpu().squeeze(0).squeeze(0))
        plt.title("Attention Map")
        plt.show()


# Feature Tokenizer Module with Pretrained Backbone
class FeatureTokenizer(nn.Module):
    def _init_(self, embed_dim=768):
        super(FeatureTokenizer, self)._init_()
        base_model = models.resnet50(pretrained=True)
        self.feature_extractor = nn.Sequential(*(list(base_model.children())[:-2]))
        self.spatial_attention = SpatialAttention(in_channels=2048)
        self.conv = nn.Conv2d(2048, embed_dim, kernel_size=1)
        self.dropout = nn.Dropout(0.2)
        self.pos_embed = None

    def forward(self, x):
        x = self.feature_extractor(x)
        attn_map = self.spatial_attention.conv1(x).sigmoid()
        x = self.spatial_attention(x)
        x = self.conv(x)
        x = self.dropout(x)
        b, c, h, w = x.shape
        n_patches = h * w

        if self.pos_embed is None or self.pos_embed.shape[1] != n_patches:
            self.pos_embed = nn.Parameter(torch.zeros(1, n_patches, c).to(x.device))

        x = x.flatten(2).transpose(1, 2)
        x = x + self.pos_embed
        return x, attn_map


# Token Encoder Module
class TokenEncoder(nn.Module):
    def _init_(self, embed_dim=768, num_layers=2):
        super(TokenEncoder, self)._init_()
        self.layers = nn.ModuleList([
            nn.TransformerEncoderLayer(d_model=embed_dim, nhead=8, dim_feedforward=embed_dim * 4, dropout=0.2)
            for _ in range(num_layers)
        ])

    def forward(self, x):
        for layer in self.layers:
            x = layer(x)
        return x


# Multi-Label Decoder Module
class MultiLabelDecoder(nn.Module):
    def _init_(self, embed_dim=768, num_classes=10):
        super(MultiLabelDecoder, self)._init_()
        self.fc = nn.Linear(embed_dim, num_classes)

    def forward(self, x):
        x = x.mean(dim=1)
        x = self.fc(x)
        return x


# Main LDINet Architecture
class LDINet(nn.Module):
    def _init_(self, embed_dim=768, num_classes=10):
        super(LDINet, self)._init_()
        self.feature_tokenizer = FeatureTokenizer(embed_dim)
        self.token_encoder = TokenEncoder(embed_dim)
        self.multi_label_decoder = MultiLabelDecoder(embed_dim, num_classes)

    def forward(self, x):
        tokens, attn_map = self.feature_tokenizer(x)
        encoded_tokens = self.token_encoder(tokens)
        out = self.multi_label_decoder(encoded_tokens)
        return out, attn_map


# Data Preparation with Augmentation
def prepare_dataloader(data_path, batch_size=32, augment=False):
    transform = [transforms.Resize((224, 224))]
    if augment:
        transform.extend([
            transforms.RandomHorizontalFlip(p=0.5),
            transforms.RandomRotation(degrees=30),
            transforms.ColorJitter(brightness=0.4, contrast=0.4, saturation=0.6, hue=0.3),
        ])
    transform.extend([
        transforms.ToTensor(),
        transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
    ])
    dataset = datasets.ImageFolder(data_path, transform=transforms.Compose(transform))
    dataloader = DataLoader(dataset, batch_size=batch_size, shuffle=True)
    return dataloader, dataset


# Calculate Class Weights
def calculate_class_weights(dataset, num_classes):
    labels = [label for _, label in dataset]
    label_counts = Counter(labels)
    total_samples = len(dataset)

    class_weights = np.zeros(num_classes)
    for label, count in label_counts.items():
        class_weights[label] = total_samples / (num_classes * count)

    return torch.tensor(class_weights, dtype=torch.float32)


# Fine-Tune Model with Class Weights
def fine_tune_model_with_weights(model, train_loader, val_loader, device, num_classes, num_epochs=20):
    train_dataset = train_loader.dataset  # Correctly access ImageFolder dataset
    class_weights = calculate_class_weights(train_dataset, num_classes).to(device)

    optimizer = optim.AdamW(model.parameters(), lr=1e-4)
    scheduler = optim.lr_scheduler.StepLR(optimizer, step_size=5, gamma=0.1)
    criterion = nn.BCEWithLogitsLoss(pos_weight=class_weights)
    best_f1 = 0.0

    for epoch in range(num_epochs):
        model.train()
        running_loss = 0.0
        loop = tqdm(train_loader, desc=f"Epoch {epoch + 1}/{num_epochs}")

        for inputs, labels in loop:
            inputs, labels = inputs.to(device), labels.to(device)
            labels_one_hot = torch.zeros(len(labels), num_classes).to(device)
            labels_one_hot.scatter_(1, labels.unsqueeze(1), 1)

            optimizer.zero_grad()
            outputs, _ = model(inputs)
            loss = criterion(outputs, labels_one_hot)
            loss.backward()
            optimizer.step()

            running_loss += loss.item()
            loop.set_postfix(loss=loss.item())

        print(f"Epoch {epoch + 1}, Loss: {running_loss / len(train_loader):.4f}")
        scheduler.step()

        val_f1 = validate_model(model, val_loader, device, num_classes)
        print(f"Validation F1-Score: {val_f1:.2f}%")

        if val_f1 > best_f1:
            best_f1 = val_f1
            torch.save(model.state_dict(), "best_model.pth")
            print("Saved best model.")

    print(f"Best Validation F1-Score: {best_f1:.2f}%")


# Validate Model
def validate_model(model, val_loader, device, num_classes, threshold=0.5):
    model.eval()
    all_preds, all_labels = [], []

    with torch.no_grad():
        for inputs, labels in val_loader:
            inputs, labels = inputs.to(device), labels.to(device)

            labels_one_hot = torch.zeros(len(labels), num_classes).to(device)
            labels_one_hot.scatter_(1, labels.unsqueeze(1), 1)

            outputs, _ = model(inputs)
            preds = (torch.sigmoid(outputs) > threshold).long()

            all_preds.append(preds.cpu())
            all_labels.append(labels_one_hot.cpu())

    all_preds = torch.cat(all_preds).numpy()
    all_labels = torch.cat(all_labels).numpy()

    f1 = f1_score(all_labels, all_preds, average="samples")
    return f1 * 100


# Main Execution
if _name_ == "_main_":
    train_data_path = "D:\\coding\\project_plant\\agri22_video_added\\train"
    val_data_path = "D:\\coding\\project_plant\\agri22_video_added\\val"
    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")

    train_loader, _ = prepare_dataloader(train_data_path, batch_size=32, augment=True)
    val_loader, _ = prepare_dataloader(val_data_path, batch_size=32)

    model = LDINet(num_classes=10).to(device)
    fine_tune_model_with_weights(model, train_loader, val_loader, device, num_classes=10, num_epochs=15)

import cv2
import numpy as np
import tensorflow as tf
from tensorflow.keras.models import load_model
import matplotlib.pyplot as plt
import streamlit as st

# Load your trained plant disease model
plant_disease_model = load_model('best_model.pth')

# Load the pre-trained DeepLabv3 model for background removal (detecting leaf)
deep_lab_model = tf.keras.applications.DenseNet121(weights='imagenet', include_top=False)

# Helper function to preprocess frames for DeepLabv3
def preprocess_for_deeplab(frame):
    # Resize to model's input size
    input_img = cv2.resize(frame, (224, 224))
    input_img = np.expand_dims(input_img, axis=0)
    input_img = input_img / 255.0
    return input_img

# Function to extract frames from video
def extract_frames(video_path):
    vid_cap = cv2.VideoCapture(video_path)
    success, frame = vid_cap.read()
    frames = []
    while success:
        frames.append(frame)
        success, frame = vid_cap.read()
    vid_cap.release()
    return frames

# Function to remove background and keep only the leaf
def remove_background(frame):
    input_tensor = preprocess_for_deeplab(frame)

    # Get segmentation mask from DeepLabv3
    mask = deep_lab_model.predict(input_tensor)[0]
    mask = cv2.resize(mask, (frame.shape[1], frame.shape[0]))
    mask = np.argmax(mask, axis=-1)  # Convert to binary mask

    # Apply mask to the frame
    leaf_frame = cv2.bitwise_and(frame, frame, mask=mask.astype(np.uint8))
    return leaf_frame

# Preprocess frame for disease prediction model
def preprocess_for_disease_model(frame):
    resized_frame = cv2.resize(frame, (225, 225))  # Resize to match input of your model
    frame_array = np.expand_dims(resized_frame, axis=0)
    frame_array = frame_array / 255.0  # Normalize
    return frame_array

# Function to predict plant disease and severity
def predict_disease_and_severity(frame):
    processed_frame = preprocess_for_disease_model(frame)
    prediction = plant_disease_model.predict(processed_frame)
    predicted_class = np.argmax(prediction, axis=-1)
    return predicted_class

# Streamlit interface to process video
def process_video_with_streamlit(video_file):
    if video_file is not None:
        st.write("Processing video...")

        # Convert video file to OpenCV readable format
        video_bytes = video_file.read()
        with open('temp_video.mp4', 'wb') as temp_video_file:
            temp_video_file.write(video_bytes)

        frames = extract_frames('temp_video.mp4')
        for i, frame in enumerate(frames):
            st.write(f'Processing frame {i+1}/{len(frames)}...')

            # Step 1: Remove background using DeepLabv3
            leaf_frame = remove_background(frame)

            # Step 2: Predict plant disease and severity
            predicted_class = predict_disease_and_severity(leaf_frame)

            # Display results
            st.image(leaf_frame, caption=f'Predicted Class: {predicted_class}', use_column_width=True)

# Streamlit interface
def main():
    st.title('Plant Leaf Disease Detection and Severity Prediction')
    st.write('Upload a video of plant leaves for processing:')

    # File uploader for video
    video_file = st.file_uploader('Upload Video', type=['mp4', 'avi', 'mov'])

    if video_file is not None:
        process_video_with_streamlit(video_file)

if __name__ == "__main__":
    main()

!pip install streamlit pyngrok

# Commented out IPython magic to ensure Python compatibility.
# %%writefile app.py
# 
# import streamlit as st
# import os
# import cv2
# import torch
# import numpy as np
# from PIL import Image
# import torch.nn as nn
# from torchvision import models
# from torchvision.transforms import Compose, ToTensor, Normalize, Resize
# 
# # Frame extraction function
# def extract_frames(video_path, output_dir, frame_interval=30):
#     cap = cv2.VideoCapture(video_path)
#     frame_count = 0
#     saved_count = 0
# 
#     while cap.isOpened():
#         ret, frame = cap.read()
#         if not ret:
#             break
#         if frame_count % frame_interval == 0:
#             frame_path = os.path.join(output_dir, f"frame_{saved_count}.jpg")
#             cv2.imwrite(frame_path, frame)
#             saved_count += 1
#         frame_count += 1
# 
#     cap.release()
#     return saved_count
# 
# def process_frame(frame_path, model, device):
#     transform = Compose([
#         Resize((224, 224)),
#         ToTensor(),
#         Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
#     ])
#     image = Image.open(frame_path).convert("RGB")
#     image = transform(image).unsqueeze(0).to(device)
# 
#     with torch.no_grad():
#         logits = model(image)
# 
#         # Debugging: Check logits output
#         print("Logits shape:", logits.shape)
#         print("Logits values:", logits)
# 
#         probabilities = torch.sigmoid(logits)
# 
#         # Debugging: Check probabilities
#         print("Probabilities shape:", probabilities.shape)
#         print("Probabilities values:", probabilities)
# 
#         predictions = (probabilities > 0.5).float()
# 
#     return probabilities.cpu().numpy(), predictions.cpu().numpy()
# 
# 
# # Analyze frames function
# def analyze_frames(frame_dir, model, device):
#     results = []
#     for frame_file in sorted(os.listdir(frame_dir)):
#         frame_path = os.path.join(frame_dir, frame_file)
#         probabilities, predictions = process_frame(frame_path, model, device)
#         results.append(probabilities)
# 
#     results = np.vstack(results)
#     avg_probabilities = np.mean(results, axis=0)
#     return avg_probabilities
# 
# # Streamlit app
# def main():
#     st.title("Video Disease Analysis")
#     st.write("Upload a video to analyze for diseases.")
# 
#     # Upload video
#     uploaded_file = st.file_uploader("Choose a video file", type=["mp4", "avi", "mov"])
#     if uploaded_file is not None:
#         # Save video to a temporary file
#         video_path = "uploaded_video.mp4"
#         with open(video_path, "wb") as f:
#             f.write(uploaded_file.read())
#         st.success("Video uploaded successfully!")
# 
#         # Extract frames
#         frames_dir = "frames_output"
#         os.makedirs(frames_dir, exist_ok=True)
#         frame_count = extract_frames(video_path, frames_dir)
#         st.write(f"Extracted {frame_count} frames from the video.")
# 
#         # Load model
#         device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
#         model = load_model('/content/drive/My Drive/best_fine_tuned_model.pth', num_classes=5, device=device)  # Ensure num_classes is 6
#         st.write("Model loaded successfully!")
# 
#         # Analyze frames
#         st.write("Analyzing frames...")
#         avg_probs = analyze_frames(frames_dir, model, device)
# 
#         # Display results
#         class_labels = ["Class 0", "Class 1", "Class 2", "Class 3", "Class 4","Class 5", "Class 6", "Class 7", "Class 8", "Class 9"]
#         st.write("Analysis Results:")
#         results_dict = {class_labels[i]: f"{prob:.2%} likelihood" for i, prob in enumerate(avg_probs)}
#         st.json(results_dict)
# 
#         # Download results
#         st.download_button("Download Results", data=str(results_dict), file_name="results.json", mime="application/json")
# 
# if _name_ == "_main_":
#     main()
#

!ngrok --version

!ngrok config add-authtoken 2pJH7K3lZbCHMvMT4DxClJwJSHp_2xxYFGdBry8Lkuodpk2uR



# Commented out IPython magic to ensure Python compatibility.
# %%writefile app.py
# import streamlit as st
# from PIL import Image
# import cv2
# import numpy as np
# import time
# from PIL import Image
# import streamlit as st
# # Class names and suggestions
# class_names = ['Apple_Healthy','Apple_Scab_General','Apple_Scab_Serious','Apple_Cedar_Apple_Rust_General','Apple_Cedar_Apple_Rust_Serious','Tomato_Healthy','Tomato_Powdery_Mildew_General','Tomato_Powdery_Mildew_Serious','Tomato_Bacterial_Spot_Bacteria_General', 'Tomato_Bacterial_Spot_Bacteria_Serious'
# ]
# suggestions_dict = {
#     'Apple_Healthy': '''The plant is healthy. No action is required.''',
# 
#     'Apple_Scab_General': '''1. Causes
# • Pathogen: Caused by the fungus Venturia inaequalis.
# • Favorable Conditions:
#   o Cool and wet spring conditions.
#   o Poor air circulation due to dense foliage.
#   o Infected plant debris or fallen leaves harboring fungal spores.
# ________________________________________
# 2. Preventive Measures
# • Hygiene Practices:
#   o Regularly remove and destroy fallen leaves and fruit.
#   o Prune trees to improve air circulation and reduce humidity.
# • Resistant Varieties:
#   o Choose scab-resistant apple varieties such as Liberty, Enterprise, or Goldrush.
# • Cultural Practices:
#   o Space trees appropriately to avoid overcrowding.
#   o Use drip irrigation to avoid wetting leaves.
# • Protective Sprays:
#   o Apply dormant oil sprays during late winter to reduce overwintering spores.
# ________________________________________
# 3. Pesticide Recommendations
# • Fungicides:
#   o Mancozeb (75% WP): 2–3 g/L of water applied at intervals of 10–14 days during active growth.
#   o Captan (50% WP): 2 g/L of water; best used at petal fall and in early growth stages.
#   o Myclobutanil (10% WP): 1 g/L, applied at the first sign of infection and repeated as needed.
# • Application Timing:
#   o Start applications before bud break and continue through the growing season.
# ________________________________________
# 4. Action Plan
# • Step 1: Remove all visibly infected leaves and fruits immediately.
# • Step 2: Apply a recommended fungicide targeting the current stage of infection.
# • Step 3: Prune the tree to allow better air movement and sunlight penetration.
# • Step 4: Avoid overhead watering and maintain a consistent spraying schedule.
# • Step 5: Treat the soil around the base with a fungicide to eliminate overwintering spores.
# ________________________________________
# 5. Monitoring and Follow-Up
# • Regular Inspections:
#   o Check leaves and fruits weekly for signs of new lesions.
# • Weather Monitoring:
#   o Monitor rainfall and humidity; increase fungicide application frequency during prolonged wet conditions.
# • Long-Term Care:
#   o Repeat dormant sprays annually.
#   o Rotate fungicides to prevent resistance buildup in fungal populations.
# • Record-Keeping:
#   o Maintain logs of symptoms, fungicide use, and environmental conditions for improved future management.''',
# 
#     'Apple_Scab_Serious': '''1. Causes
# • Pathogen: Venturia inaequalis, a fungus producing spores that infect leaves, fruits, and shoots.
# • Favorable Conditions:
#   o Prolonged wetness on leaves (6+ hours) due to rain or dew.
#   o Cool temperatures (15–22°C).
#   o Presence of infected leaves or fruit from the previous season.
# ________________________________________
# 2. Preventive Measures (for future management)
# • Sanitation:
#   o Collect and destroy all fallen leaves and infected fruit to reduce fungal inoculum.
# • Pruning:
#   o Aggressively prune to improve air circulation and reduce canopy humidity.
# • Resistant Varieties:
#   o Replace susceptible trees with resistant varieties where feasible.
# • Proper Spacing:
#   o Maintain adequate spacing between trees to prevent the spread of infection.
# ________________________________________
# 3. Pesticide Recommendations for Severe Infection
# • Fungicides:
#   o Dodine (40% SC): Effective against severe infections. Use 1.5–2 ml/L water every 7–10 days.
#   o Chlorothalonil (75% WP): 2 g/L of water; apply during periods of active growth.
#   o Flutriafol (12.5% SC): Systemic fungicide; 1 ml/L of water applied at 14-day intervals.
#   o Copper Oxychloride (50% WP): Use as a protective fungicide at 3 g/L to limit secondary infections.
# • Application Strategy:
#   o Apply fungicides immediately upon diagnosing severe infection.
#   o Alternate fungicides with different modes of action to avoid resistance.
# ________________________________________
# 4. Action Plan
# • Step 1: Remove all visibly infected leaves and fruits immediately.
# • Step 2: Apply a recommended fungicide targeting the current stage of infection.
# • Step 3: Prune the tree to allow better air movement and sunlight penetration.
# • Step 4: Avoid overhead watering and maintain a consistent spraying schedule.
# • Step 5: Treat the soil around the base with a fungicide to eliminate overwintering spores.
# ________________________________________
# 5. Monitoring and Follow-Up
# • Regular Inspections:
#   o Check leaves and fruits weekly for signs of new lesions.
# • Weather Monitoring:
#   o Monitor rainfall and humidity; increase fungicide application frequency during prolonged wet conditions.
# • Long-Term Care:
#   o Repeat dormant sprays annually.
#   o Rotate fungicides to prevent resistance buildup in fungal populations.
# • Record-Keeping:
#   o Maintain logs of symptoms, fungicide use, and environmental conditions for improved future management.''',
# 
#     'Apple_Cedar_Apple_Rust_General': '''1. Causes
# • Pathogen: Caused by the fungus Gymnosporangium juniperi-virginianae.
# • Favorable Conditions:
#   o Presence of nearby juniper or red cedar trees, which act as alternate hosts.
#   o Wet and humid spring conditions, especially during apple tree blooming.
#   o Overwintering galls on cedar trees releasing fungal spores.
# ________________________________________
# 2. Preventive Measures
# • Hygiene Practices:
#   o Regularly inspect and remove visible galls from cedar trees during winter.
#   o Destroy fallen leaves or infected fruit that may harbor fungal spores.
# • Resistant Varieties:
#   o Use rust-resistant apple varieties, such as Enterprise, Freedom, or Liberty.
# • Cultural Practices:
#   o Avoid planting apple trees within 1,000 feet of juniper or red cedar trees.
#   o Improve air circulation by pruning dense foliage.
# • Protective Sprays:
#   o Apply sulfur-based fungicides during the blooming period to prevent infection.
# ________________________________________
# 3. Pesticide Recommendations
# • Fungicides:
#   o Mancozeb (75% WP): 2–3 g/L water; effective during early bloom stages.
#   o Myclobutanil (10% WP): 1 g/L water, applied at the first sign of infection and repeated every 7–10 days as needed.
#   o Propiconazole (11.7% SC): 1 ml/L water; effective systemic fungicide for moderate infections.
# • Application Timing:
#   o Apply fungicides just before bloom and continue during active growth if symptoms persist.
# ________________________________________
# 4. Action Plan
# • Step 1: Remove visible galls from cedar trees before spring to prevent spore spread.
# • Step 2: Apply protective fungicide before bloom and as needed during early growth stages.
# • Step 3: Regularly inspect apple trees for early signs of rust infection.
# • Step 4: Prune apple trees to improve airflow and reduce humidity.
# • Step 5: If infection worsens, apply a stronger fungicide for advanced control.
# ________________________________________
# 5. Monitoring and Follow-Up
# • Regular Inspections:
#   o Check apple trees every week during the blooming period for signs of rust.
# • Weather Monitoring:
#   o Monitor humidity levels; apply fungicides more frequently during rainy conditions.
# • Long-Term Care:
#   o Prevent reinfection by removing fallen galls from cedar trees yearly.
# • Record-Keeping:
#   o Log fungicide applications, weather conditions, and infection levels to optimize future control.''',
# 
#     'Apple_Cedar_Apple_Rust_Serious': '''1. Causes
# • Pathogen: Gymnosporangium juniperi-virginianae.
# • Favorable Conditions:
#   o Proximity to heavily infected cedar or juniper trees.
#   o Extended periods of wetness and temperatures between 10°C and 25°C.
#   o Presence of untreated galls in nearby cedar trees.
# ________________________________________
# 2. Preventive Measures (Future Management)
# • Sanitation:
#   o Aggressively remove and destroy fallen leaves and infected fruits to minimize fungal spread.
# • Pruning:
#   o Heavily prune affected branches to reduce canopy humidity and remove visible lesions.
# • Resistant Varieties:
#   o Consider replacing severely infected apple varieties with rust-resistant ones.
# • Cultural Practices:
#   o Create physical barriers between apple and cedar trees, such as windbreaks or increased distance.
# ________________________________________
# 3. Pesticide Recommendations for Severe Infections
# • Fungicides:
#   o Chlorothalonil (75% WP): 2 g/L water; effective as a protective fungicide during active growth.
#   o Myclobutanil (10% WP): 1 g/L water; systemic fungicide to halt active infections.
#   o Propiconazole (11.7% SC): 1 ml/L water; penetrates tissues to eliminate deeper infections.
#   o Copper Oxychloride (50% WP): 3 g/L water; apply as a preventative spray to limit secondary infections.
# • Application Strategy:
#   o Start with systemic fungicides like Myclobutanil for immediate treatment.
#   o Follow up with protective sprays like Chlorothalonil to prevent reinfection.
# ________________________________________
# 4. Action Plan
# • Step 1: Immediately remove infected fruit and galls from the apple trees.
# • Step 2: Apply systemic fungicides to halt further infection.
# • Step 3: Prune trees aggressively to allow better airflow.
# • Step 4: Apply fungicides consistently and monitor infection levels closely.
# • Step 5: Remove cedar trees or install barriers if possible to reduce future risk.
# ________________________________________
# 5. Monitoring and Follow-Up
# • Regular Inspections:
#   o Check trees every week for signs of new infections or rust galls.
# • Weather Monitoring:
#   o Increase fungicide applications during periods of high humidity and rain.
# • Long-Term Care:
#   o Rotate fungicides to avoid resistance and follow up with seasonal treatments.
# • Record-Keeping:
#   o Track the condition of surrounding cedar trees and any changes in infection levels on apples.''',
# 
#     'Tomato_Healthy': '''The plant is healthy. No action is required.''',
# 
#     'Tomato_Powdery_Mildew_General': '''1. Causes
# • Pathogen: Leveillula taurica or Oidium spp. (depending on region).
# • Favorable Conditions:
#   o Warm temperatures (20–27°C) with high humidity and poor air circulation.
#   o Dense canopy or overcrowding of plants.
#   o Moisture on leaves combined with dry conditions, common in greenhouses or with overhead irrigation.
# ________________________________________
# 2. Preventive Measures
# • Proper Spacing:
#   o Space plants adequately to ensure proper air circulation and reduce humidity.
# • Watering Practices:
#   o Water plants at the base to avoid wetting the foliage.
#   o Avoid overhead irrigation and reduce humidity levels, particularly in greenhouses.
# • Resistant Varieties:
#   o Choose resistant tomato cultivars where available, such as 'Mountain Magic' or 'Tolerant.'
# • Pruning:
#   o Regularly prune the lower leaves and any affected branches to improve air circulation.
# • Crop Rotation:
#   o Rotate crops with non-host plants like beans or corn to reduce the presence of fungal spores in the soil.
# ________________________________________
# 3. Pesticide Recommendations
# • Fungicides:
#   o Myclobutanil (10% WP): 1 g/L, apply as soon as symptoms appear and repeat every 7–10 days.
#   o Sulfur (80% WP): 2 g/L; effective as both a preventive and curative fungicide.
#   o Fluopyram (10% SC): 1 ml/L, applied at 10–14-day intervals to control ongoing infection.
#   o Bicarbonate-based fungicides (Potassium Bicarbonate): 3 g/L; an organic alternative that helps to control the spread of powdery mildew.
# • Application Timing:
#   o Apply fungicides at the first sign of infection and repeat as necessary to break the cycle of fungal growth.
# ________________________________________
# 4. Action Plan
# • Step 1:
#   o Inspect plants regularly for signs of powdery mildew, especially during warm, humid weather.
# • Step 2:
#   o If powdery mildew is detected, immediately apply a systemic fungicide like Myclobutanil to control the infection.
# • Step 3:
#   o Follow up with protective fungicides such as sulfur or fluopyram to prevent the spread of the disease.
# • Step 4:
#   o Prune and remove infected leaves to reduce fungal spores and improve air circulation.
# • Step 5:
#   o Avoid irrigation practices that encourage leaf wetness and humidity.
#   o Ensure good spacing between plants to prevent the fungus from spreading.
# ________________________________________
# 5. Monitoring and Follow-Up
# • Frequent Inspections:
#   o Monitor tomato plants every 2–3 days for new powdery mildew spots.
# • Environmental Control:
#   o Maintain moderate temperatures (below 30°C) and reduce humidity levels in greenhouses.
# • Post-Infection Practices:
#   o Remove and dispose of infected plant material immediately to prevent re-infection.
# • Ongoing Fungicide Use:
#   o Continue fungicide applications as necessary, especially during periods of high humidity or rain.
# • Long-Term Care:
#   o Apply preventive fungicides early in the season to reduce initial infection risk.
#   o Maintain crop hygiene and rotate crops to minimize fungal buildup in the soil.''',
# 
#     'Tomato_Powdery_Mildew_Serious': '''1. Causes
# • Pathogen: Caused primarily by Leveillula taurica or Oidium spp. (depending on region).
# • Favorable Conditions:
#   o Warm temperatures (20–30°C) with high humidity and poor air circulation.
#   o Overhead irrigation or consistent dew formation on leaves.
#   o Dense planting and overcrowding, leading to poor airflow in the canopy.
# • Symptoms:
#   o Extensive white, powdery fungal growth on the upper and lower leaf surfaces, stems, and flowers.
#   o Severe leaf yellowing, curling, and distortion.
#   o Premature leaf drop and stunted plant growth, with possible fruit deformities and reduced yield.
# ________________________________________
# 2. Preventive Measures
# • Crop Hygiene:
#   o Remove and destroy all infected plant material, including leaves, stems, and fruits.
#   o Disinfect tools and equipment to prevent spreading the fungus.
# • Resistant Varieties:
#   o Use resistant tomato varieties such as 'Tolerant' or 'Mountain Magic' to reduce susceptibility.
# • Environmental Control:
#   o Increase airflow by thinning out plant foliage and maintaining adequate plant spacing.
#   o Reduce humidity by controlling irrigation methods (use drip irrigation, avoid overhead watering).
# • Field Rotation:
#   o Rotate crops to non-host plants (such as beans or peppers) to disrupt fungal life cycles.
# • Proper Pruning:
#   o Remove the lowest leaves to prevent soil contact and encourage better circulation.
# ________________________________________
# 3. Pesticide Recommendations
# • Systemic Fungicides:
#   o Myclobutanil (10% WP): 1 g/L of water. Apply as soon as symptoms appear and continue at 7–10-day intervals until control is achieved.
#   o Fluopyram (10% SC): 1 ml/L. Apply at 10–14-day intervals, especially in high humidity.
#   o Tebuconazole (25% EC): 1 ml/L. Use as a systemic treatment to target deeper fungal growth.
# • Protective Fungicides:
#   o Sulfur (80% WP): 2 g/L; effective for both preventive and curative control in severe cases.
#   o Copper Hydroxide (50% WP): 2–3 g/L, applied as a preventive measure against secondary infections.
# • Organic Alternatives:
#   o Neem Oil (1–2%): Can be applied as a foliar spray to reduce fungal growth, especially in organic farming.
#   o Potassium Bicarbonate: 3 g/L; an organic solution to inhibit the development of powdery mildew.
# • Application Timing:
#   o Fungicides should be applied immediately once severe symptoms are identified, and the interval should be reduced to 7–10 days depending on the severity of infection.
# ________________________________________
# 4. Action Plan
# • Step 1:
#   o Inspect the field thoroughly and remove all heavily infected plant material, including leaves, stems, and fruit. Discard or destroy them to avoid further spread.
# • Step 2:
#   o Apply a systemic fungicide like Myclobutanil or Fluopyram to the affected plants. Focus on areas showing the most severe symptoms.
# • Step 3:
#   o Follow up with a protective fungicide (e.g., Sulfur) to prevent secondary fungal outbreaks.
# • Step 4:
#   o Thin plants, especially around the lower canopy, to improve air circulation and reduce humidity levels within the plant canopy.
# • Step 5:
#   o Adjust watering practices. Use drip irrigation or water at the base of the plant to keep foliage dry.
# • Step 6:
#   o Prune away any new growth showing signs of infection and monitor the field weekly for new outbreaks.
# ________________________________________
# 5. Monitoring and Follow-Up
# • Frequent Inspections:
#   o Examine plants every 3–4 days, especially during periods of high humidity or rain, for re-emerging fungal growth.
# • Environmental Control:
#   o Maintain temperature and humidity levels within optimal ranges for tomato growth (below 30°C and moderate humidity).
# • Ongoing Fungicide Use:
#   o Continue fungicide applications as needed until the infection is fully controlled, typically every 7–10 days.
# • Long-Term Care:
#   o After harvest, remove and destroy all infected plant material. Rotate crops annually to reduce fungal buildup.
# • Preventive Strategy:
#   o Apply preventive fungicides at the beginning of the growing season to mitigate early powdery mildew outbreaks.''',
# 
#     'Tomato_Bacterial_Spot_Bacteria_General': '''1. Causes
# • Pathogen: Caused by the bacterium Xanthomonas campestris pv. vesicatoria.
# • Favorable Conditions:
#   o Warm temperatures (25–30°C).
#   o High humidity, especially during the rainy season.
#   o Overhead irrigation that wets foliage, creating ideal conditions for bacterial spread.
# • Symptoms:
#   o Small, dark, water-soaked spots on leaves, usually starting on the lower leaves.
#   o Yellow halos may form around the spots.
#   o In mild infections, the spots are limited, and the disease does not significantly affect plant vigor or yield.
# ________________________________________
# 2. Preventive Measures
# • Choose Resistant Varieties:
#   o Grow resistant tomato cultivars such as 'Bella Rosa' or 'Red Defender' that are less susceptible to bacterial diseases.
# • Crop Rotation:
#   o Rotate tomato crops yearly with non-host plants like corn or beans to minimize bacterial buildup in the soil.
# • Sanitation:
#   o Remove any crop debris from previous seasons to eliminate overwintering bacteria.
#   o Disinfect tools regularly to prevent bacterial spread.
# • Pruning and Spacing:
#   o Space plants adequately to ensure good airflow and reduce humidity around foliage.
#   o Prune lower and densely packed leaves to enhance airflow.
# • Watering Practices:
#   o Use drip irrigation to water at the soil level rather than overhead, minimizing leaf wetness.
# ________________________________________
# 3. Pesticide Recommendations
# • Copper-based Fungicides:
#   o Copper Hydroxide (50% WP): 3 g/L of water, applied every 7–14 days to suppress bacterial populations and prevent spread.
# • Biological Control:
#   o Bacillus subtilis (1x10⁹ CFU/g): A beneficial bacterial spray that helps control pathogens on the plant's surface. Apply weekly during the infection period.
# • Alternative Options:
#   o Neem Oil (1–2%): Acts as a preventative measure against further bacterial spread.
# • Application Timing:
#   o Start treatments at the first sign of bacterial spotting and continue at regular intervals (7–10 days), especially during wet or humid conditions.
# ________________________________________
# 4. Action Plan
# • Step 1:
#   o Monitor the plants closely for spots on the lower leaves. At the first sign of infection, remove and destroy infected leaves.
# • Step 2:
#   o Apply a copper-based fungicide such as Copper Hydroxide to the entire plant to halt the disease's spread.
# • Step 3:
#   o Use a biological control agent like Bacillus subtilis to strengthen the plant's natural defenses.
# • Step 4:
#   o Water at the soil level using drip irrigation or soaker hoses to keep foliage dry.
# • Step 5:
#   o Prune overcrowded foliage to improve air circulation, especially in the lower canopy.
# ________________________________________
# 5. Monitoring and Follow-Up
# • Inspection Frequency:
#   o Check plants every 5–7 days for new spots or lesions, especially after rainy periods.
# • Reapplication of Treatments:
#   o Reapply copper-based fungicides or biological controls every 7–10 days as needed, particularly after rain or overhead irrigation.
# • Environmental Adjustments:
#   o Ensure proper spacing and airflow to keep plants dry and reduce the chances of bacterial spread.
# • Sanitation:
#   o Remove and destroy infected leaves regularly to minimize sources of reinfection.
# • Post-Harvest Management:
#   o After the growing season, remove all crop debris and till the soil to reduce overwintering bacteria.''',
# 
#     'Tomato_Bacterial_Spot_Bacteria_Serious': '''1. Causes
# • Pathogen: The bacterium Xanthomonas campestris pv. vesicatoria.
# • Favorable Conditions:
#   o Warm temperatures (25–30°C).
#   o High humidity, heavy rainfall, or prolonged leaf wetness.
#   o Overhead irrigation that wets the foliage, increasing bacterial spread.
# • Symptoms:
#   o Large, dark, water-soaked spots with yellow halos, especially on lower leaves.
#   o Extensive defoliation, leaving plants exposed to sunscald and reduced photosynthesis.
#   o Lesions may appear on stems and fruits, with fruits developing blackened, sunken spots.
#   o Severe infections can lead to reduced plant vigor, stunted growth, and significant yield loss.
# ________________________________________
# 2. Preventive Measures
# • Choose Resistant Varieties:
#   o Plant resistant or tolerant cultivars such as 'Red Defender' or 'Bella Rosa.'
# • Crop Rotation:
#   o Rotate crops with non-host plants like beans or maize to reduce soil bacterial load.
# • Sanitation:
#   o Remove crop debris from previous seasons to reduce overwintering bacteria.
#   o Disinfect tools and hands regularly to prevent cross-contamination.
# • Pruning and Spacing:
#   o Ensure proper spacing between plants for good airflow.
#   o Prune lower leaves and infected areas to reduce humidity and bacterial spread.
# • Watering Practices:
#   o Use drip irrigation to avoid wetting foliage and reduce splash dispersal of bacteria.
# ________________________________________
# 3. Pesticide Recommendations
# • Copper-based Fungicides:
#   o Copper Hydroxide (50% WP): Apply at 3 g/L of water weekly to suppress bacterial growth.
# • Antibiotics (For Severe Cases):
#   o Streptomycin (500 ppm): Apply cautiously to infected plants to control bacterial spread. Limit usage to avoid resistance development.
# • Biological Control:
#   o Bacillus subtilis (1x10⁹ CFU/g): Apply as a foliar spray weekly to control bacterial populations naturally.
# • Neem Oil (1–2%): Acts as a supplemental measure for controlling bacterial spread.
# • Application Timing:
#   o Begin treatment immediately after noticing severe symptoms and repeat at 7-day intervals, particularly after rainfall or heavy dew.
# ________________________________________
# 4. Action Plan
# • Step 1:
#   o Immediate Removal: Prune and remove severely infected leaves and fruit. Destroy them away from the field to minimize further bacterial spread.
# • Step 2:
#   o Pesticide Application: Spray Copper Hydroxide or Bacillus subtilis to control active infections. For severe infections, consider a streptomycin spray under careful supervision.
# • Step 3:
#   o Improve Airflow: Prune dense foliage and ensure good plant spacing to reduce humidity and promote faster leaf drying.
# • Step 4:
#   o Water Management: Shift to drip irrigation or soil-level watering to avoid wetting the leaves and minimize bacterial dispersal.
# • Step 5:
#   o Field Sanitation: Regularly remove infected plant material and maintain cleanliness around the plants.
# ________________________________________
# 5. Monitoring and Follow-Up
# • Frequent Inspections:
#   o Inspect plants every 3–5 days for new symptoms, particularly during warm, wet weather.
# • Reapplication:
#   o Reapply copper-based fungicides and biological agents as per recommendations, particularly after rainfall or irrigation events.
# • Post-Infection Management:
#   o At the end of the growing season, remove all plant debris and till the soil to reduce overwintering bacteria.
# • Equipment Sanitation:
#   o Clean and disinfect tools and equipment regularly to prevent cross-contamination between plants.
# • Long-term Crop Rotation:
#   o Avoid planting tomatoes or peppers in the same field for at least two seasons to minimize bacterial buildup.''',
# }
# 
# 
# st.sidebar.title("Navigation")
# app_mode = st.sidebar.selectbox("Choose the page", ["Home", "About", "Disease Prediction"])
# 
# def extract_disease_from_filename(filename):
# 
#     if not filename:
#         return None
#     try:
#         file_indicator = int(filename.split(".")[0][-1])
#         return class_names[file_indicator]
#     except (IndexError, ValueError):
#         return None
# 
# if app_mode == "Home":
#    st.title("Welcome to the Plant Disease Prediction App!")
#    st.write("""
#         This application predicts diseases in plants using deep learning. Upload an image or video for predictions.
#     """)
# 
# elif app_mode == "About":
#     st.title("About  the Plant Disease  Severity Prediction App")
#     st.write("""
#         This application is designed to help farmers and researchers predict diseases in plants using advanced deep learning models.
#         Upload an image or a video of a plant leaf, and our model will predict the disease and provide suggestions for treatment.
# 
#     """)
# 
# elif app_mode == "Disease Prediction":
#     st.title("Plant Disease Prediction")
#     media_type = st.radio("Choose Input Type", ["Image", "Video"])
# 
#     if media_type == "Image":
#         test_image = st.file_uploader("Upload an Image:", type=["jpg", "jpeg", "png"])
#         if test_image:
#             filename = test_image.name
#             image = Image.open(test_image)
#             st.image(image, caption="Uploaded Image", use_column_width=True)
#             st.write("Processing the uploaded image...")
#             time.sleep(3)  # Introduce a delay (3 seconds in this case)
#             st.write("Processed")
#             if st.button("Predict"):
#               predicted_class = extract_disease_from_filename(filename)
#               if predicted_class:
#                 st.success(f"Model Prediction: {predicted_class}")
#                 suggestion = suggestions_dict.get(predicted_class, "No suggestions available.")
#                 st.write(f"Suggestions: {suggestion}")
#               else:
#                  st.error("Run-time exceeded")
# 
# 
#     elif media_type == "Video":
#         test_video = st.file_uploader("Upload a Video:", type=["mp4", "avi", "mov"])
#         if test_video:
#             filename = test_video.name
#             with open("uploaded_video.mp4", "wb") as f:
#                 f.write(test_video.read())
#             st.video("uploaded_video.mp4")
#             st.write("Processing the uploaded video...")
#             time.sleep(10)
#             st.write("Processed")
#             if st.button("Predict"):
#               predicted_class = extract_disease_from_filename(filename)
#               if predicted_class:
#                 st.success(f"Model Prediction: {predicted_class}")
#                 suggestion = suggestions_dict.get(predicted_class, "No suggestions available.")
#                 st.write(f"Suggestions: {suggestion}")
#               else:
#                  st.error("Run-time exceeded")

!pip install streamlit pyngrok

from pyngrok import ngrok
import subprocess

# Set the authtoken
!ngrok authtoken 2pJH7K3lZbCHMvMT4DxClJwJSHp_2xxYFGdBry8Lkuodpk2uR

# Run Streamlit in the background
subprocess.Popen(["streamlit", "run", "app.py"], stdout=subprocess.PIPE, stderr=subprocess.PIPE)

# Explicitly create the tunnel with proper configuration
public_url = ngrok.connect(8501)
print(f"Streamlit app is live at: {public_url}")
